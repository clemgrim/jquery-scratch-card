!function(e,t,o){"use strict";function s(){var e=t.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}function a(t,o){var s=this;s.$el=t,s.options=e.extend({},e.fn.scratch.defaults,o),s.imagesLoaded().done(e.proxy(s.init,s))}var i=s(),n=!1;a.prototype={pixels:[],isComplete:!1,lastPos:!1,canvas:null,ctx:null,$el:null,options:{},scratchablePx:0,scratchedPx:0,init:function(){var e=this;e.$el.show();var o=e.options.width||e.$el.children().eq(0).width(),s=i?"canvas":"div";e.$el.width(o).height(e.options.height),e.canvas=t.createElement(s),e.canvas.setAttribute("class","scratch-overlay scratch-"+s),i&&(e.canvas.width=e.$el.outerWidth(),e.canvas.height=e.$el.outerHeight(),e.ctx=e.canvas.getContext("2d")),e.$el.hide(),e.createOverlay(function(){e.$el.show(),e.scratchablePx=e.getVisiblePixels(),e.getPixels(),e.enable()}),e.$el.append(e.canvas).append('<div class="scratch-cursor"/>').on("scratch.complete",e.options.onComplete).on("scratch.scratch",e.options.onScratch).on("scratch.disable",e.options.onDisable).on("scratch.enable",e.options.onEnable).on("scratch.reset",e.options.onReset).find("img").on("dragstart",function(){return!1})},imagesLoaded:function(){var t=this.$el.find("img").map(function(){var t=e.Deferred(),o=new Image;return o.onload=t.resolve,o.src=this.src,t.promise()}).toArray();return e.when.apply(e,t)},createOverlay:function(t){var o=this;if(i)if(o.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),"#"===o.options.background.substr(0,1))o.ctx.fillStyle=o.options.background,o.ctx.fillRect(0,0,o.canvas.width,o.canvas.height);else{var s=new Image;s.onload=function(){o.ctx.drawImage(s,0,0),e.isFunction(t)&&t()},s.src=o.options.background}else"#"===o.options.background.substr(0,1)?o.canvas.style.backgroundColor=o.options.background:o.canvas.style.backgroundImage="url("+o.options.background+")",e.isFunction(t)&&t()},getVisiblePixels:function(){var e,t=this,o=t.ctx.getImageData(0,0,t.canvas.width,t.canvas.height).data,s=0;for(e=0;e<o.length;e+=4)o[e+3]>.3&&s++;return s},getPixels:function(){var e,t,o,s=this,a=s.canvas.width,i=s.canvas.height,n=s.ctx.getImageData(0,0,a,i).data;for(s.pixels=[],t=0;i>t;t++)for(e=0;i>e;e++)o=n[4*(a*t+e)+3],s.pixels[e]||(s.pixels[e]=[]),s.pixels[e][t]=.3>o?-1:1},getRatio:function(e){var t=this;if(!i)return t.isComplete?1:0;if(!e)return 1-t.getVisiblePixels()/t.scratchablePx;var o,s,a,n,c=0,r=t.pixels.length,l=t.pixels[0].length,h=0;for(o=0;r>o;o++)for(s=0;l>s;s++)-1!==t.pixels[o][s]&&(0===t.pixels[o][s]&&(a=Math.pow(1-2*Math.abs(o-r/2)/r,1.5),n=Math.pow(1-2*Math.abs(s-l/2)/l,1.5),c+=a*n),h++);return c/h},mousemove:function(e){e.preventDefault();var t=this,o=t.$el.offset(),s=(e.pageX||e.originalEvent.touches[0].pageX)-o.left,a=(e.pageY||e.originalEvent.touches[0].pageY)-o.top;if(t.$el.find(".scratch-cursor").css({top:a-t.options.cursorWidth,left:s-t.options.cursorWidth,display:"block"}),n||"click"===e.type){if(t.lastPos){var i,c,r,l,h;if(s==t.lastPos.x)for(r=Math.min(a,t.lastPos.y),l=Math.max(a,t.lastPos.y),h=t.options.cursorWidth/2,c=r;l>c;c+=h)t.scratch(s,c);else{r=Math.min(s,t.lastPos.x),l=Math.max(s,t.lastPos.x),h=t.options.cursorWidth/4;var u=(t.lastPos.y-a)/(t.lastPos.x-s),d=a-u*s;for(i=r;l>i;i+=h)c=u*i+d,t.scratch(i,c)}}else t.scratch(s,a);"click"!==e.type&&(t.lastPos={x:s,y:a}),t.$el.trigger("scratch.scratch"),t.isRevealed()&&t.clear()}},scratch:function(e,t){var o,s,a=this,i=Math.round(a.options.cursorWidth/2);for(e=parseInt(e),t=parseInt(t),o=-i;i>o;o++)for(s=-i;i>s;s++)(!a.options.isCircle||Math.sqrt(o*o+s*s)<=i)&&a.pixels[e+o]&&1===a.pixels[e+o][t+s]&&(a.pixels[e+o][t+s]=0);a.options.isCircle?(a.ctx.save(),a.ctx.globalCompositeOperation="destination-out",a.ctx.beginPath(),a.ctx.arc(e,t,i,0,2*Math.PI),a.ctx.closePath(),a.ctx.fillStyle="rgba(0, 0, 0, 1)",a.ctx.fill(),a.ctx.restore()):a.ctx.clearRect(e-i,t-i,a.options.cursorWidth,a.options.cursorWidth)},isRevealed:function(){var e=this;return e.options.revealRatio?e.getRatio(!0)>e.options.revealRatio:e.getRatio()>=e.options.percent/100},enable:function(){var t=this;t.$el.find(".scratch-overlay").removeClass("scratch-overlay-disabled").show(),t.isComplete||t.isRevealed()||(i?(t.$el.on("mousemove touchmove click",e.proxy(t.mousemove,t)),t.$el.on("mouseleave",function(){t.$el.find(".scratch-cursor").hide()})):t.$el.on("click",function(){t.$el.find(".scratch-overlay").fadeOut(e.proxy(t.clear,t))}),t.$el.on("mouseleave mouseup touchend",function(){t.lastPos=!1})),t.$el.trigger("scratch.enable")},clear:function(){var e=this;e.disable(),e.isComplete=!0,e.lastPos=!1,n=!1,e.$el.find(".scratch-overlay").hide(),e.$el.trigger("scratch.complete",e.getRatio(),e.getRatio(!0))},reset:function(){var t=this;t.disable(),t.isComplete=!1,t.scratchablePx=t.getVisiblePixels(),t.getPixels(),t.createOverlay(e.proxy(t.enable,t)),t.$el.trigger("scratch.reset")},disable:function(){var e=this;e.$el.find(".scratch-cursor").hide(),e.$el.off("mousemove touchmove click"),e.$el.find(".scratch-overlay").addClass("scratch-overlay-disabled"),e.$el.trigger("scratch.disabled")},destroy:function(){this.clear(),this.$el.removeData(o).off("scratch.complete").off("scratch.scratch").off("scratch.disable").off("scratch.enable").off("scratch.reset").find("img").off("dragstart")}},e.fn[o]=function(t){t=t||{};var s,i,n,c,r=[].slice.call(arguments,1),l=[];return c=this.map(function(){if(s=e(this),i=s.data(o)){if(e.isFunction(i[t]))n=i[t].apply(i,r);else if("promise"!==t)throw new Error("Unknown method "+t)}else i=new a(s,t),s.data(o,i);var c=e.Deferred();return i.isComplete?c.resolve():s.one("scratch.complete",c.resolve),l.push(c.promise()),"undefined"==typeof n?this:n}),e.isFunction(t.onAllComplete)?e.when.apply(e,l).done(t.onAllComplete):"promise"===t&&e.isFunction(r[0])&&e.when.apply(e,l).done(r[0]),c.length>1?c:c[0]},e.fn[o].defaults={background:"#666",width:null,height:"auto",cursorWidth:20,isCircle:!0,percent:65,revealRatio:.11,onComplete:null,onScratch:null,onDisable:null,onEnable:null,onReset:null},e(function(){e("body").on("mousedown touchstart",function(){n=!0}).on("mouseup touchend",function(){n=!1})})}(jQuery,document,"scratch");