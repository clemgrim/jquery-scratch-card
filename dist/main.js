!function(e,t,o){"use strict";function n(){var e=t.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}function s(e){e()}function i(t,n){var i=this;i.$el=t.queue(o,[s]),i.options=e.extend({},e.fn.scratch.defaults,n),i.imagesLoaded().done(e.proxy(i.init,i))}var a=n(),c=!1;i.prototype={isComplete:!1,lastPos:!1,cnv:null,ctx:null,$el:null,options:{},scratchablePx:0,init:function(){var e,n,s=this;s.$el.show(),e=s.options.width||s.$el.children().eq(0).width(),n=a?"canvas":"div",s.$el.width(e).height(s.options.height),s.cnv=t.createElement(n),s.cnv.setAttribute("class","scratch-overlay scratch-"+n),a&&(s.cnv.width=s.$el.outerWidth(),s.cnv.height=s.$el.outerHeight(),s.ctx=s.cnv.getContext("2d")),s.$el.hide(),s.createOverlay(function(){s.$el.show(),s.scratchablePx=s.getVisiblePixels(),s.enable()}),s.$el.append(s.cnv).append('<div class="scratch-cursor"/>').on(o+".complete",s.options.onComplete).on(o+".scratch",s.options.onScratch).on(o+".disable",s.options.onDisable).on(o+".enable",s.options.onEnable).on(o+".reset",s.options.onReset).find("img").on("dragstart",function(){return!1})},imagesLoaded:function(){var e="scratch.loaded",t=this.$el.find("img");return t.each(function(){t.queue(e,s);var o=new Image;o.onload=t.dequeue.bind(t,e),o.src=this.src}).promise(e)},createOverlay:function(t){var o=this,n=o.options.background,s=o.cnv.width,i=o.cnv.height;if(a)if(o.ctx.clearRect(0,0,s,i),"#"===n.substr(0,1))o.ctx.fillStyle=n,o.ctx.fillRect(0,0,s,i);else{var c=new Image;c.onload=function(){o.ctx.drawImage(c,0,0,s,i),e.isFunction(t)&&t()},c.src=n}else"#"===n.substr(0,1)?o.cnv.style.backgroundColor=n:o.cnv.style.backgroundImage="url("+n+")",e.isFunction(t)&&t()},getVisiblePixels:function(){try{var e,t=this.cnv,o=this.ctx.getImageData(0,0,t.width,t.height).data,n=0;for(e=0;e<o.length;e+=4)o[e+3]>.3&&n++;return n}catch(s){return console.log("Cannot determine visible pixels for this scratch card"),0}},getRatio:function(){return a?1-this.getVisiblePixels()/this.scratchablePx:this.isComplete?1:0},mousemove:function(e){e.preventDefault();var t=this,o=t.options,n=t.$el.offset(),s=(e.pageX||e.originalEvent.touches[0].pageX)-n.left,i=(e.pageY||e.originalEvent.touches[0].pageY)-n.top;if(t.$el.find(".scratch-cursor").css({top:i-o.cursorWidth,left:s-o.cursorWidth,display:"block"}),c||"click"===e.type){if(t.lastPos){var a,r,l,u,h;if(s==t.lastPos.x)for(l=Math.min(i,t.lastPos.y),u=Math.max(i,t.lastPos.y),h=o.cursorWidth/2,r=l;u>r;r+=h)t.scratch(s,r);else{l=Math.min(s,t.lastPos.x),u=Math.max(s,t.lastPos.x),h=o.cursorWidth/4;var d=(t.lastPos.y-i)/(t.lastPos.x-s),f=i-d*s;for(a=l;u>a;a+=h)r=d*a+f,t.scratch(a,r)}}else t.scratch(s,i);"click"!==e.type&&(t.lastPos={x:s,y:i}),t.trigger("scratch"),t.isRevealed()&&t.clear()}},scratch:function(e,t){var o=this.ctx,n=this.options,s=Math.round(n.cursorWidth/2);e=parseInt(e),t=parseInt(t),n.isCircle?(o.save(),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(e,t,s,0,2*Math.PI),o.closePath(),o.fillStyle="rgba(0, 0, 0, 1)",o.fill(),o.restore()):o.clearRect(e-s,t-s,n.cursorWidth,n.cursorWidth)},isRevealed:function(){return this.getRatio()>=this.options.percent/100},trigger:function(e){return this.$el.trigger(o+"."+e,[].slice.call(arguments,1))},enable:function(){var t=this,o=t.$el;o.find(".scratch-overlay").removeClass("scratch-overlay-disabled").show(),t.isComplete||t.isRevealed()||(a?(o.on("mousemove touchmove click",e.proxy(t.mousemove,t)),o.on("mouseleave",function(){o.find(".scratch-cursor").hide()})):o.on("click",function(){o.find(".scratch-overlay").fadeOut(e.proxy(t.clear,t))}),o.on("mouseleave mouseup touchend",function(){t.lastPos=!1})),t.trigger("enable")},clear:function(){var e=this;e.disable(),e.isComplete=!0,e.lastPos=!1,c=!1,e.$el.find(".scratch-overlay").hide(),e.trigger("complete",e.getRatio()).dequeue(o)},reset:function(){var e=this;e.disable(),e.isComplete=!1,e.createOverlay(function(){e.$el.show(),e.scratchablePx=e.getVisiblePixels(),e.enable()}),e.trigger("reset").queue(o,[s])},disable:function(){var e=this.$el;e.find(".scratch-cursor").hide(),e.off("mousemove touchmove click"),e.find(".scratch-overlay").addClass("scratch-overlay-disabled"),self.trigger("disabled")},destroy:function(){this.clear(),this.$el.removeData(o).off(o+".complete").off(o+".scratch").off(o+".disable").off(o+".enable").off(o+".reset").find("img").off("dragstart")}},e.fn[o]=function(t){t=t||{};var n,s,a,c,r=[].slice.call(arguments,1);return c=this.map(function(){return n=e(this),(s=n.data(o))?e.isFunction(s[t])&&(a=s[t].apply(s,r)):(s=new i(n,t),n.data(o,s)),"undefined"==typeof a?this:a}),c.length>1?c:c[0]},e.fn[o].defaults={background:"#666",width:null,height:"auto",cursorWidth:20,isCircle:!0,percent:65,onComplete:null,onScratch:null,onDisable:null,onEnable:null,onReset:null},e(function(){e(t).on("mousedown touchstart",function(){c=!0}).on("mouseup touchend",function(){c=!1})})}(jQuery,document,"scratch");