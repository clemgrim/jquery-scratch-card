!function(t,e,o){"use strict";function s(){var t=e.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}function a(e,o){var s=this;s.$el=e,s.options=t.extend({},t.fn.scratch.defaults,o),s.init()}var n=s(),i=!1;a.prototype={pixels:[],isComplete:!1,lastPos:!1,canvas:null,ctx:null,$el:null,options:{},init:function(){var t=this;t.$el.show();var o=t.options.width||t.$el.children().eq(0).width(),s=n?"canvas":"div";t.$el.width(o).height(t.options.height),t.canvas=e.createElement(s),t.canvas.setAttribute("class","scratch-overlay scratch-"+s),n&&(t.canvas.width=t.$el.outerWidth(),t.canvas.height=t.$el.outerHeight(),t.ctx=t.canvas.getContext("2d")),t.$el.hide(),t.createOverlay(function(){t.$el.show(),t.enable()}),t.$el.append(t.canvas).append('<div class="scratch-cursor"/>').on("scratch.complete",t.options.onComplete).on("scratch.scratch",t.options.onScratch).on("scratch.disable",t.options.onDisable).on("scratch.enable",t.options.onEnable).on("scratch.reset",t.options.onReset).find("img").on("dragstart",function(){return!1})},createOverlay:function(e){var o=this;if(n)if(o.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),"#"===o.options.background.substr(0,1))o.ctx.fillStyle=o.options.background,o.ctx.fillRect(0,0,canvasWidth,canvasHeight);else{var s=new Image;s.onload=function(){o.ctx.drawImage(s,0,0),t.isFunction(e)&&e()},s.src=o.options.background}else"#"===o.options.background.substr(0,1)?o.canvas.style.backgroundColor=o.options.background:o.canvas.style.backgroundImage="url("+o.options.background+")",t.isFunction(e)&&e()},getPixels:function(){var t,e,o,s,a=this,i=a.canvas.width,c=a.canvas.height;if(a.pixels=[],n)for(o=a.ctx.getImageData(0,0,i,c).data,t=0;i>t;t++)for(e=0;c>e;e++)a.pixels[t]||(a.pixels[t]=[]),s=o[e*i+t+4],.3>s?a.pixels[t][e]=-1:a.pixels[t][e]=1},getRatio:function(t){var e=this;if(!n)return e.isComplete?1:0;var o,s,a,i,c=0,r=e.pixels.length,l=e.pixels[0].length,h=0;for(o=0;r>o;o++)for(s=0;l>s;s++)-1!==e.pixels[o][s]&&(0===e.pixels[o][s]&&(t?(a=Math.pow(1-2*Math.abs(o-r/2)/r,1.5),i=Math.pow(1-2*Math.abs(s-l/2)/l,1.5),c+=a*i):c++),h++);return c/h},mousemove:function(t){t.preventDefault();var e=this,o=e.$el.offset(),s=(t.pageX||t.originalEvent.touches[0].pageX)-o.left,a=(t.pageY||t.originalEvent.touches[0].pageY)-o.top;if(e.$el.find(".scratch-cursor").css({top:a-e.options.cursorWidth,left:s-e.options.cursorWidth,display:"block"}),i||"click"===t.type){if(e.lastPos){var n,c,r,l,h;if(s==e.lastPos.x)for(r=Math.min(a,e.lastPos.y),l=Math.max(a,e.lastPos.y),h=e.options.cursorWidth/2,c=r;l>c;c+=h)e.scratch(s,c);else{r=Math.min(s,e.lastPos.x),l=Math.max(s,e.lastPos.x),h=e.options.cursorWidth/4;var u=(e.lastPos.y-a)/(e.lastPos.x-s),p=a-u*s;for(n=r;l>n;n+=h)c=u*n+p,e.scratch(n,c)}}else e.scratch(s,a);"click"!==t.type&&(e.lastPos={x:s,y:a}),e.$el.trigger("scratch.scratch"),e.isRevealed()&&e.clear()}},scratch:function(t,e){var o,s,a=this,n=Math.round(a.options.cursorWidth/2);for(t=parseInt(t),e=parseInt(e),o=-n;n>o;o++)for(s=-n;n>s;s++)(!a.options.isCircle||Math.sqrt(o*o+s*s)<=n)&&a.pixels[t+o]&&1===a.pixels[t+o][e+s]&&(a.pixels[t+o][e+s]=0);a.options.isCircle?(a.ctx.save(),a.ctx.globalCompositeOperation="destination-out",a.ctx.beginPath(),a.ctx.arc(t,e,n,0,2*Math.PI),a.ctx.closePath(),a.ctx.fillStyle="rgba(0, 0, 0, 1)",a.ctx.fill(),a.ctx.restore()):a.ctx.clearRect(t-n,e-n,a.options.cursorWidth,a.options.cursorWidth)},isRevealed:function(){var t=this;return t.options.revealRatio?t.getRatio(!0)>t.options.revealRatio:t.getRatio()>=t.options.percent/100},enable:function(){var e=this;e.$el.find(".scratch-overlay").removeClass("scratch-overlay-disabled").show(),e.getPixels(),e.isComplete||e.isRevealed()||(n?(e.$el.on("mousemove touchmove click",t.proxy(e.mousemove,e)),e.$el.on("mouseleave",function(){e.$el.find(".scratch-cursor").hide()})):e.$el.on("click",function(){e.$el.find(".scratch-overlay").fadeOut(t.proxy(e.clear,e))}),e.$el.on("mouseleave mouseup touchend",function(){e.lastPos=!1})),e.$el.trigger("scratch.enable")},clear:function(){var t=this;t.disable(),t.isComplete=!0,t.lastPos=!1,i=!1,t.$el.find(".scratch-overlay").hide(),t.$el.trigger("scratch.complete",t.getRatio(),t.getRatio(!0))},reset:function(){var e=this;e.disable(),e.isComplete=!1,e.createOverlay(t.proxy(e.enable,e)),e.$el.trigger("scratch.reset")},disable:function(){var t=this;t.$el.find(".scratch-cursor").hide(),t.$el.off("mousemove touchmove click"),t.$el.find(".scratch-overlay").addClass("scratch-overlay-disabled"),t.$el.trigger("scratch.disabled")},destroy:function(){this.clear(),this.$el.removeData(o).off("scratch.complete").off("scratch.scratch").off("scratch.disable").off("scratch.enable").off("scratch.reset").find("img").off("dragstart")}},t.fn[o]=function(e){e=e||{};var s,n,i,c,r=[].slice.call(arguments,1),l=[];return c=this.map(function(){if(s=t(this),n=s.data(o)){if(t.isFunction(n[e]))i=n[e].apply(n,r);else if("promise"!==e)throw new Error("Unknown method "+e)}else n=new a(s,e),s.data(o,n);var c=t.Deferred();return n.isComplete?c.resolve():s.one("scratch.complete",c.resolve),l.push(c.promise()),"undefined"==typeof i?this:i}),t.isFunction(e.onAllComplete)?t.when.apply(t,l).done(e.onAllComplete):"promise"===e&&t.isFunction(r[0])&&t.when.apply(t,l).done(r[0]),c.length>1?c:c[0]},t.fn[o].defaults={background:"#666",width:null,height:"auto",cursorWidth:20,isCircle:!0,percent:90,revealRatio:.11,onComplete:null,onScratch:null,onDisable:null,onEnable:null,onReset:null},t(function(){t("body").on("mousedown touchstart",function(){i=!0}).on("mouseup touchend",function(){i=!1})})}(jQuery,document,"scratch");