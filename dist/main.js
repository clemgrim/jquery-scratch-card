!function(e,t,o){"use strict";function s(){var e=t.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}function n(t,o){var s=this;s.$el=t,s.options=e.extend({},e.fn.scratch.defaults,o),s.imagesLoaded().done(e.proxy(s.init,s))}var c=s(),a=!1;n.prototype={isComplete:!1,lastPos:!1,cnv:null,ctx:null,$el:null,options:{},scratchablePx:0,scratchedPx:0,init:function(){var e=this;e.$el.show();var o=e.options.width||e.$el.children().eq(0).width(),s=c?"canvas":"div";e.$el.width(o).height(e.options.height),e.cnv=t.createElement(s),e.cnv.setAttribute("class","scratch-overlay scratch-"+s),c&&(e.cnv.width=e.$el.outerWidth(),e.cnv.height=e.$el.outerHeight(),e.ctx=e.cnv.getContext("2d")),e.$el.hide(),e.createOverlay(function(){e.$el.show(),e.scratchablePx=e.getVisiblePixels(),e.enable()}),e.$el.append(e.cnv).append('<div class="scratch-cursor"/>').on("scratch.complete",e.options.onComplete).on("scratch.scratch",e.options.onScratch).on("scratch.disable",e.options.onDisable).on("scratch.enable",e.options.onEnable).on("scratch.reset",e.options.onReset).find("img").on("dragstart",function(){return!1})},imagesLoaded:function(){var t=this.$el.find("img").map(function(){var t=e.Deferred(),o=new Image;return o.onload=t.resolve,o.src=this.src,t.promise()}).toArray();return e.when.apply(e,t)},createOverlay:function(t){var o=this;if(c)if(o.ctx.clearRect(0,0,o.cnv.width,o.cnv.height),"#"===o.options.background.substr(0,1))o.ctx.fillStyle=o.options.background,o.ctx.fillRect(0,0,o.cnv.width,o.cnv.height);else{var s=new Image;s.onload=function(){o.ctx.drawImage(s,0,0),e.isFunction(t)&&t()},s.src=o.options.background}else"#"===o.options.background.substr(0,1)?o.cnv.style.backgroundColor=o.options.background:o.cnv.style.backgroundImage="url("+o.options.background+")",e.isFunction(t)&&t()},getVisiblePixels:function(){var e,t=this,o=t.ctx.getImageData(0,0,t.cnv.width,t.cnv.height).data,s=0;for(e=0;e<o.length;e+=4)o[e+3]>.3&&s++;return s},getRatio:function(){var e=this;return c?1-e.getVisiblePixels()/e.scratchablePx:e.isComplete?1:0},mousemove:function(e){e.preventDefault();var t=this,o=t.$el.offset(),s=(e.pageX||e.originalEvent.touches[0].pageX)-o.left,n=(e.pageY||e.originalEvent.touches[0].pageY)-o.top;if(t.$el.find(".scratch-cursor").css({top:n-t.options.cursorWidth,left:s-t.options.cursorWidth,display:"block"}),a||"click"===e.type){if(t.lastPos){var c,r,i,l,h;if(s==t.lastPos.x)for(i=Math.min(n,t.lastPos.y),l=Math.max(n,t.lastPos.y),h=t.options.cursorWidth/2,r=i;l>r;r+=h)t.scratch(s,r);else{i=Math.min(s,t.lastPos.x),l=Math.max(s,t.lastPos.x),h=t.options.cursorWidth/4;var u=(t.lastPos.y-n)/(t.lastPos.x-s),d=n-u*s;for(c=i;l>c;c+=h)r=u*c+d,t.scratch(c,r)}}else t.scratch(s,n);"click"!==e.type&&(t.lastPos={x:s,y:n}),t.$el.trigger("scratch.scratch"),t.isRevealed()&&t.clear()}},scratch:function(e,t){var o=this,s=Math.round(o.options.cursorWidth/2);e=parseInt(e),t=parseInt(t),o.options.isCircle?(o.ctx.save(),o.ctx.globalCompositeOperation="destination-out",o.ctx.beginPath(),o.ctx.arc(e,t,s,0,2*Math.PI),o.ctx.closePath(),o.ctx.fillStyle="rgba(0, 0, 0, 1)",o.ctx.fill(),o.ctx.restore()):o.ctx.clearRect(e-s,t-s,o.options.cursorWidth,o.options.cursorWidth)},isRevealed:function(){return this.getRatio()>=this.options.percent/100},enable:function(){var t=this;t.$el.find(".scratch-overlay").removeClass("scratch-overlay-disabled").show(),t.isComplete||t.isRevealed()||(c?(t.$el.on("mousemove touchmove click",e.proxy(t.mousemove,t)),t.$el.on("mouseleave",function(){t.$el.find(".scratch-cursor").hide()})):t.$el.on("click",function(){t.$el.find(".scratch-overlay").fadeOut(e.proxy(t.clear,t))}),t.$el.on("mouseleave mouseup touchend",function(){t.lastPos=!1})),t.$el.trigger("scratch.enable")},clear:function(){var e=this;e.disable(),e.isComplete=!0,e.lastPos=!1,a=!1,e.$el.find(".scratch-overlay").hide(),e.$el.trigger("scratch.complete",e.getRatio())},reset:function(){var t=this;t.disable(),t.isComplete=!1,t.scratchablePx=t.getVisiblePixels(),t.createOverlay(e.proxy(t.enable,t)),t.$el.trigger("scratch.reset")},disable:function(){var e=this;e.$el.find(".scratch-cursor").hide(),e.$el.off("mousemove touchmove click"),e.$el.find(".scratch-overlay").addClass("scratch-overlay-disabled"),e.$el.trigger("scratch.disabled")},destroy:function(){this.clear(),this.$el.removeData(o).off("scratch.complete").off("scratch.scratch").off("scratch.disable").off("scratch.enable").off("scratch.reset").find("img").off("dragstart")}},e.fn[o]=function(t){t=t||{};var s,c,a,r,i=[].slice.call(arguments,1),l=[];return r=this.map(function(){if(s=e(this),c=s.data(o)){if(e.isFunction(c[t]))a=c[t].apply(c,i);else if("promise"!==t)throw new Error("Unknown method "+t)}else c=new n(s,t),s.data(o,c);var r=e.Deferred();return c.isComplete?r.resolve():s.one("scratch.complete",r.resolve),l.push(r.promise()),"undefined"==typeof a?this:a}),e.isFunction(t.onAllComplete)?e.when.apply(e,l).done(t.onAllComplete):"promise"===t&&e.isFunction(i[0])&&e.when.apply(e,l).done(i[0]),r.length>1?r:r[0]},e.fn[o].defaults={background:"#666",width:null,height:"auto",cursorWidth:20,isCircle:!0,percent:65,onComplete:null,onScratch:null,onDisable:null,onEnable:null,onReset:null},e(function(){e("body").on("mousedown touchstart",function(){a=!0}).on("mouseup touchend",function(){a=!1})})}(jQuery,document,"scratch");